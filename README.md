# Manifest Generator for Talon

![Version](https://img.shields.io/badge/version-2.0.0-blue)
![Status](https://img.shields.io/badge/status-preview-orange)
![License](https://img.shields.io/badge/license-Unlicense-green)

Provides scripts for generating package-like files for your Talon repo: `manifest.json` with dependencies and contributions, `_version.py` with version actions and dependency validation, `README.md` with shield badges and installation instructions, and more.

## Installation

Clone this repo into your [Talon](https://talonvoice.com/) user directory:

```sh
# mac and linux
cd ~/.talon/user

# windows
cd ~/AppData/Roaming/talon/user

git clone https://github.com/rokubop/talon-manifest-generator
```

## Scripts

**Quick start:** Use `generate_all.py` to run all generators at once, or run individual scripts for specific tasks.

### generate_manifest.py
Parses Python and Talon files to detect Talon entities (actions, settings, tags, lists, modes, scopes, captures, and apps) you contribute or depend on. Scans user directory to find all other packages with manifests to build an index of available packages. Maps your imported entities to specific packages and their versions. Creates or updates `manifest.json` with all discovered information, preserving your manual edits to fields like name, description, etc.

```bash
python generate_manifest.py ../talon-repo
```

### generate_version.py
Generates a `_version.py` file that exposes your `manifest.json` package version as a Talon action e.g., `actions.user.my_package_version()`. Also includes automatic dependency validation on Talon startup, printing clear error messages if dependencies are missing or outdated with installation/update instructions for other packages that have a `{user.other_package}_version()` Talon action.

```bash
python generate_version.py ../talon-repo
```

### generate_readme.py
Creates or updates `README.md` files with shield badges, description, and installation instructions. For existing READMEs, only updates the shield badges (preserves your custom installation instructions). Automatically includes `preview.png` if it exists in the package directory.

```bash
python generate_readme.py ../talon-repo
```

### generate_shields.py
Generates or updates shield badges in your `README.md` based on your `manifest.json`. Badges show package version, status, platform, license, and Talon Beta requirement (if applicable). If no README exists, prints badges to console for copy/paste.

```bash
python generate_shields.py ../talon-repo
```

### generate_install_block.py
Outputs formatted installation instructions for your package based on your `manifest.json`, including dependency information. Useful for quickly generating README installation sections. Only supports single directory.

```bash
python generate_install_block.py ../talon-repo
```

### generate_all.py
Runs all generators in sequence: `generate_manifest.py`, `generate_version.py`, and `generate_readme.py`. Creates or updates `manifest.json`. Creates or updates `_version.py`. Creates `README.md` if it doesn't exist, or updates shields in existing READMEs (preserves your custom content).

```bash
python generate_all.py ../talon-repo
```

### Additional notes
You can provide multiple folders to most scripts
```bash
python generate_all.py ../talon-repo-1 ../talon-repo-2
```

## Example `manifest.json`

```json
{
  "name": "talon-my-package",
  "title": "My Package",
  "description": "A brief description of what the package does",
  "version": "1.0.0",
  "namespace": "user.my_package",
  "github": "https://github.com/user/my-package",
  "preview": "",
  "status": "experimental",
  "author": "Your Name",
  "tags": ["productivity", "editing"],
  "dependencies": {
    "talon-ui-elements": {
      "version": "0.13.0",
      "namespace": "user.ui_elements",
      "github": "https://github.com/user/talon-ui-elements"
    }
  },
  "devDependencies": {},
  "contributes": {
    "actions": ["user.my_package_action"],
    "settings": ["user.my_package_setting"]
  },
  "depends": {
    "actions": ["user.ui_elements_show"]
  },
  "requiresTalonBeta": false,
  "_generator": "talon-manifest-generator",
  "_generatorVersion": "2.0.0",
  "_generatorRequiresVersionAction": true,
  "_generatorStrictNamespace": true
}
```

## Example `README.md`

``````md
# {manifest.title}

![Version](https://img.shields.io/badge/version-{manifest.version}-blue)
![Status](https://img.shields.io/badge/status-{manifest.status}-orange)

{manifest.description}

## Installation

Clone this repo into your [Talon](https://talonvoice.com/) user directory:

```sh
# mac and linux
cd ~/.talon/user

# windows
cd ~/AppData/Roaming/talon/user

git clone {manifest.github}
```
``````

## Example `_version.py` (no dependency check)

```py
"""
DO NOT EDIT - Auto-generated file
Generated by talon-manifest-generator v2.0.0

This file provides:
- Package version checking via parrot_tester_version() action
"""
import json
import os
from talon import Module

mod = Module()

@mod.action_class
class Actions:
    def parrot_tester_version() -> tuple[int, int, int]:
        """
        Returns the package version as (major, minor, patch).

        Usage: actions.user.parrot_tester_version() >= (1, 2, 0)
        """
        manifest_path = os.path.join(os.path.dirname(__file__), 'manifest.json')
        with open(manifest_path, 'r', encoding='utf-8') as f:
            version_str = json.load(f)['version']
        return tuple(map(int, version_str.split('.')))
```

## Example `_version.py` (with dependencies)
```py
def validate_dependencies():
    """
    Checks dependencies from manifest.json and calls {namespace}_version()
    for each to verify installed versions meet requirements on Talon startup.

    Prints warnings to Talon log when dependencies are missing or outdated,
    including installation/update instructions. Can be disabled by setting
    'validateDependencies': false in manifest.json.
    """
    try:
        with open(os.path.join(os.path.dirname(__file__), 'manifest.json'), 'r') as f:
            data = json.load(f)

        if not data.get('validateDependencies', True):
            return

        deps = data.get('dependencies', {})
        errors = []

        for dep, info in deps.items():
            version_action = f"{info['namespace']}_version"
            github_url = info.get('github', '')
            try:
                action_ref = actions
                for part in version_action.split('.'):
                    action_ref = getattr(action_ref, part)
                installed = action_ref()
                required = tuple(int(x) for x in info['version'].split('.'))
                if installed < required:
                    installed_str = '.'.join(map(str, installed))
                    errors.append(f"  Update {dep} to {info['version']}+ (currently {installed_str})")
                    if github_url:
                        errors.append(f"    Navigate to the {dep} directory and run: git pull")
                        errors.append(f"    {github_url}")
            except AttributeError:
                errors.append(f"  Cannot verify {dep} {info['version']}+ (missing or invalid {version_action} action)")
                if github_url:
                    errors.append(f"    Install/update from: {github_url}")
            except Exception as e:
                errors.append(f"  {dep}: {e}")

        if errors:
            print(f"\n{data.get('name')}: dependency not met")
            for error in errors:
                print(error)
            print("  WARNING: Review code from unfamiliar sources before installing")
            print(f"  To disable these warnings, set 'validateDependencies': false in {data.get('name')}/manifest.json")
            print()
    except:
        pass

app.register("ready", validate_dependencies)
```

## Example Talon log (dependency not met)

```
2026-01-18 12:32:12.386    IO talon-face-tester: dependency not met
2026-01-18 12:32:12.387    IO
2026-01-18 12:32:12.387    IO   Cannot verify talon-ui-elements 0.13.0+ (missing or invalid user.ui_elements_version action)
2026-01-18 12:32:12.387    IO     Install/update from: https://github.com/rokubop/talon-ui-elements
2026-01-18 12:32:12.387    IO   WARNING: Review code from unfamiliar sources before installing
2026-01-18 12:32:12.387    IO   To disable these warnings, set 'validateDependencies': false in talon-face-tester/manifest.json
```

```
2026-01-18 12:34:16.382    IO talon-parrot-tester: dependency not met
2026-01-18 12:34:16.382    IO
2026-01-18 12:34:16.382    IO   Update talon-ui-elements to 0.14.0+ (currently 0.13.0)
2026-01-18 12:34:16.382    IO     Navigate to the talon-ui-elements directory and run: git pull
2026-01-18 12:34:16.382    IO     https://github.com/rokubop/talon-ui-elements
2026-01-18 12:34:16.382    IO   WARNING: Review code from unfamiliar sources before installing
2026-01-18 12:34:16.382    IO   To disable these warnings, set 'validateDependencies': false in talon-parrot-tester/manifest.json
```

### Manifest Fields

| Field | Description |
|-------|-------------|
| name | Package identifier (defaults to folder name, preserved on updates). Recommendation for folder & name: prefix with "talon-". |
| title | Human-readable package title. Recommendation: "Title Case" format |
| description | Brief description of package functionality |
| version | Semantic version number (major.minor.patch) |
| namespace | Naming prefix for all talon actions in this package (e.g. `user.ui_elements` means all actions in this package are `user.ui_elements_*`). Best practice: all your actions should use the same namespace. Set `_generatorStrictNamespace` to false to allow multiple namespaces and skip validation warnings. |
| github | GitHub repository URL |
| preview | Preview image URL (inferred if a preview.png or similar image format is included) |
| author | Package author name (string) or names (list of strings) |
| status | Package status/category. Can be any value, but these get automatic shield colors: "reference" (personal config/examples, not meant to be used directly), "prototype" (proof of concept, testing ideas), "experimental" (early stage, expect rough edges), "preview" (functional but still improving), "stable" (production-ready, safe to depend on), "deprecated" (stop using, migrate to alternative), "archived" (no longer maintained) |
| tags | Arbitrary category tags for the package |
| platforms | Platform compatibility (manually added, optional). Array of platform names, e.g. `["windows", "mac", "linux"]`. |
| license | License type (auto-detected from LICENSE file on first run, manually editable, optional). Only included if LICENSE file exists or manually set. Common values: MIT, Apache-2.0, GPL-3.0, BSD-3-Clause, ISC, Unlicense |
| dependencies | Auto-generated. Required packages (other packages that also have `manifest.json` and `_version.py` generated by this generator) as dict mapping package name to object with `version` (minimum version required, e.g. "0.10.0" means 0.10.0 or higher), `namespace`, and `github` fields. Once set, versions are preserved - update manually if needed. |
| devDependencies | Dev-only dependencies (manually move items here from `dependencies` if only needed for testing/development) |
| contributes | Auto-generated. Actions/settings/tags/modes/etc. this package provides |
| depends | Auto-generated. Actions/settings/tags/modes/etc. this package uses |
| requiresTalonBeta | Auto-detected on first run (parrot/face/deck in .talon files, ctx.dynamic_list/ctx.selections in .py files). Once checked and set, the value is preserved on subsequent runs - manual changes are respected. |
| validateDependencies | Whether to validate dependencies on Talon start (default: true if dependencies exist, omitted otherwise). Set to false to disable dependency validation. |
| _generator | Generator e.g. "talon-manifest-generator" |
| _generatorVersion | Version of the generator |
| _generatorRequiresVersionAction | Whether the generator should require a version action (default: true if namespace exists). Set to false to disable version action requirement check |
| _generatorStrictNamespace | Whether the generator should validate namespace consistency (default: true). Set to false to allow multiple namespaces and skip validation warnings. Useful for collection packages like talon-community |
| _generatorUpdateRequires | Whether the generator should auto-detect and update the requires array (default: true). Set to false to preserve manual requires exactly as-is. |
| _generatorShields | Whether to generate/update shield badges in README.md (default: true). Set to false to disable automatic shield generation. |

Most fields are preserved across regenerations, but `contributes`, `depends`, and `dependencies` (except for `version`) are auto-generated each time.

## Troubleshooting

### Python Version Error

The script requires **Python 3.12 or higher**. If you get a version error, you can use Talon's bundled Python 3.13 instead:

**Windows:**
```bash
"C:\Program Files\Talon\python.exe" generate_manifest.py ../talon-package
```

**Mac:**
```bash
/Applications/Talon.app/Contents/Resources/python/bin/python3 generate_manifest.py ../talon-package
```

**Linux:**
```bash
~/.talon/bin/python3 generate_manifest.py ../talon-package
```